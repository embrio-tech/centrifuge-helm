name: Release Charts

on:
  push:
    branches:
      - main

jobs:
  release:
    # depending on default permission settings for your org (contents being read-only or read-write for workloads), you will have to add permissions
    # see: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#modifying-the-permissions-for-the-github_token
    if: "!contains(github.event.head_commit.message, '[skip release]')"
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add helm dependencies repo
        run: |
          helm repo add cloudnative-pg https://cloudnative-pg.github.io/charts

      - name: Detect changed chart directories
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: charts/**
          dir_names: true
          dir_names_max_depth: 2
          json: true

      - name: Build changed chart list
        id: changed
        run: |
          set -euo pipefail
          CHANGED_DIRS='${{ steps.changed-files.outputs.all_changed_files }}'
          if [ -z "$CHANGED_DIRS" ] || [ "$CHANGED_DIRS" = "null" ]; then
            CHANGED_DIRS="[]"
          fi
          if [[ "$CHANGED_DIRS" == \[* ]]; then
            CHANGED_DIRS="$(echo "$CHANGED_DIRS" | jq -r '.[]')"
          fi
          CHANGED_CHARTS="$(printf '%s\n' $CHANGED_DIRS | awk -F/ 'NF>=2{print $2}' | sort -u | tr '\n' ' ' | xargs)"
          if [ -z "$CHANGED_CHARTS" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "charts=$CHANGED_CHARTS" >> "$GITHUB_OUTPUT"

      - name: Update chart dependencies
        if: steps.changed.outputs.changed == 'true'
        run: |
          set -euo pipefail
          for chart in ${{ steps.changed.outputs.charts }}; do
            helm dependency update "charts/$chart"
          done

      - name: Bump chart versions
        if: steps.changed.outputs.changed == 'true'
        run: |
          set -euo pipefail
          for chart in ${{ steps.changed.outputs.charts }}; do
            CHART_FILE="charts/$chart/Chart.yaml"
            version="$(yq e '.version' "$CHART_FILE")"
            IFS='.' read -r major minor patch <<<"$version"
            new_version="${major}.${minor}.$((patch + 1))"
            yq e -i ".version = \"${new_version}\"" "$CHART_FILE"
            echo "$CHART_FILE: version: $version -> version: $new_version"
          done

      - name: Commit version bumps
        if: steps.changed.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: bump chart versions [skip release]"
          file_pattern: "charts/*/Chart.yaml"
          commit_user_name: "${{ github.actor }}"
          commit_user_email: "${{ github.actor }}@users.noreply.github.com"

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.7.0
        if: steps.changed.outputs.changed == 'true'
        with:
          charts_dir: charts
          skip_existing: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"